generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/@prisma/client-custom-v2"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider     = "sqlite"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// Enums removed for SQLite compatibility. 
// Validated via application logic (Zod).

//// USER & AUTH

model User {
  id                 String    @id @default(uuid())
  name               String
  email              String    @unique
  password           String
  role               String // SUPER_ADMIN | ADMIN | SALES | ACCOUNTS | VIEWER
  avatar             String?   // Stores SVG content or ID
  lastLogin          DateTime?
  lastPasswordChange DateTime?
  forceLogoutBefore  DateTime?
  createdAt          DateTime  @default(now())

  labelCartItems             LabelCartItem[]
  labelPrintJobs             LabelPrintJob[]
  createdLandingPageVersions LandingPageVersion[]

  // Quotation Relations
  createdQuotations  Quotation[]            @relation("CreatedQuotations")
  approvedQuotations Quotation[]            @relation("ApprovedQuotations")
  marginAnalytics    SalesMarginAnalytics[]
  priceOverrides     PriceOverrideAudit[]

  dashboardNotes     DashboardNote[]
}

//// LANDING PAGE SETTINGS (VERSIONED)

model LandingPageSettings {
  id                String    @id @default(uuid())
  brandTitle        String    @default("KhyatiGems™ ERP")
  subtitle          String    @default("Internal Operations & Management Platform")
  accessNotice      String    @default("Authorized internal access only")
  slideshowEnabled  Boolean   @default(true)
  highlightsEnabled Boolean   @default(true)
  whatsNewEnabled   Boolean   @default(false)
  highlights        String    @default("[]") // JSON string array
  whatsNewText      String?
  whatsNewUpdatedAt DateTime?
  activeVersion     Int       @default(1)
  updatedByUserId   String
  updatedAt         DateTime  @updatedAt

  slides LandingPageSlide[]
}

model LandingPageSlide {
  id           String  @id @default(uuid())
  settingsId   String
  title        String
  description  String
  displayOrder Int
  isActive     Boolean @default(true)

  settings LandingPageSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@index([settingsId])
}

model LandingPageVersion {
  id              String   @id @default(uuid())
  versionNumber   Int
  snapshot        String // Full JSON snapshot of settings + slides
  createdByUserId String
  createdAt       DateTime @default(now())
  isRollback      Boolean  @default(false)

  createdBy User @relation(fields: [createdByUserId], references: [id])

  @@index([createdByUserId])
}

//// MASTER DATA CODES

model CategoryCode {
  id          String      @id @default(uuid())
  name        String      @unique
  code        String      @unique
  status      String      @default("ACTIVE")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inventories Inventory[]
}

model GemstoneCode {
  id          String      @id @default(uuid())
  name        String      @unique
  code        String      @unique
  status      String      @default("ACTIVE")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inventories Inventory[]
}

model ColorCode {
  id          String      @id @default(uuid())
  name        String      @unique
  code        String      @unique
  status      String      @default("ACTIVE")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inventories Inventory[]
}

model CutCode {
  id          String      @id @default(uuid())
  name        String      @unique
  code        String      @unique
  status      String      @default("ACTIVE")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inventories Inventory[]
}

model CollectionCode {
  id          String      @id @default(uuid())
  name        String      @unique
  code        String      @unique
  status      String      @default("ACTIVE")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inventories Inventory[]
}

model RashiCode {
  id          String      @id @default(uuid())
  name        String      @unique
  code        String      @unique
  status      String      @default("ACTIVE")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inventories Inventory[]
}

//// VENDORS

model Vendor {
  id         String   @id @default(uuid())
  name       String   @unique
  phone      String?
  email      String?
  address    String?
  city       String?
  state      String?
  country    String?
  vendorType String?
  gstin      String?
  pan        String?
  notes      String?
  status     String   @default("PENDING") // PENDING, APPROVED, BLOCKED
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  purchases Purchase[]
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String?
  address   String?
  city      String?
  state     String?
  country   String?
  pincode   String?
  pan       String?
  gstin     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quotations Quotation[]
  sales      Sale[]
}

//// INVENTORY & PRODUCTS

model Inventory {
  id              String   @id @default(uuid())
  sku             String   @unique
  itemName        String
  internalName    String?
  category        String // Loose, Certified, Parcel
  gemType         String?
  description     String?
  pieces          Int      @default(1)
  weightValue     Float?   @default(0)
  weightUnit      String?
  carats          Float   @default(0)
  weightRatti     Float?
  costPrice       Float
  sellingPrice    Float
  profit          Float?
  status          String   @default("IN_STOCK") // IN_STOCK, SOLD, MEMO, PROCESSING
  location        String?
  certificateNo   String?
  certification   String?
  lab             String? // GIA, IGI, HRD
  shape           String?
  color           String?
  clarity         String?
  cut             String?
  polish          String?
  symmetry        String?
  fluorescence    String?
  measurements    String?
  dimensionsMm    String?
  tablePercent    Float?
  depthPercent    Float?
  ratio           Float?
  origin          String?
  treatment       String?
  transparency    String?
  
  // Jewelry specific fields
  braceletType        String?
  standardSize        String?
  beadSizeMm          Float?
  beadCount           Int?
  holeSizeMm          Float?
  innerCircumferenceMm Float?
  
  // Pricing
  pricingMode         String  @default("FIXED") // FIXED, PER_CARAT
  sellingRatePerCarat Float?
  flatSellingPrice    Float?
  purchaseRatePerCarat Float?
  flatPurchaseCost    Float?
  notes               String?
  stockLocation       String?
  
  purchaseId      String?
  vendorId        String?
  batchId         String?
  imageUrl        String?
  videoUrl        String?
  rapPrice        Float?   @default(0)
  discountPercent Float?   @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations to Codes
  categoryCodeId   String?
  categoryCode     CategoryCode?   @relation(fields: [categoryCodeId], references: [id])
  
  gemstoneCodeId   String?
  gemstoneCode     GemstoneCode?   @relation(fields: [gemstoneCodeId], references: [id])
  
  colorCodeId      String?
  colorCode        ColorCode?      @relation(fields: [colorCodeId], references: [id])
  
  cutCodeId        String?
  cutCode          CutCode?        @relation(fields: [cutCodeId], references: [id])
  
  collectionCodeId String?
  collectionCode   CollectionCode? @relation(fields: [collectionCodeId], references: [id])
  
  rashis           RashiCode[]
  media            InventoryMedia[]

  // Relations
  purchase       Purchase?       @relation(fields: [purchaseId], references: [id])
  listings       Listing[]
  sales          Sale[]
  memoItems      MemoItem[]
  quotationItems QuotationItem[]
  labelCartItems LabelCartItem[]

  @@index([purchaseId])
  @@index([status])
  @@index([category])
  @@index([categoryCodeId])
  @@index([gemstoneCodeId])
  @@index([colorCodeId])
  @@index([cutCodeId])
  @@index([collectionCodeId])
}

model InventoryMedia {
  id          String   @id @default(uuid())
  inventoryId String
  mediaUrl    String
  type        String   // IMAGE, VIDEO
  isPrimary   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  @@index([inventoryId])
}

model Purchase {
  id            String    @id @default(uuid())
  invoiceNo     String?
  purchaseDate  DateTime
  vendorId      String?
  totalAmount   Float
  paymentStatus String    @default("PENDING") // PENDING, PAID, PARTIAL
  paymentMode   String?   // CASH, BANK, etc.
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  items         Inventory[]

  vendor Vendor? @relation(fields: [vendorId], references: [id])

  @@index([vendorId])
}

//// SALES & LISTINGS

model Listing {
  id          String   @id @default(uuid())
  inventoryId String
  platform    String // RAPNET, IDEX, WEBSITE, ETSY, EBAY
  externalId  String?
  listedPrice Float
  currency    String   @default("USD")
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE, SOLD
  listedDate  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  listingUrl  String?
  listingRef  String?

  inventory Inventory @relation(fields: [inventoryId], references: [id])
  priceHistory ListingPriceHistory[]

  @@index([inventoryId])
}

model ListingPriceHistory {
  id        String   @id @default(uuid())
  listingId String
  price     Float
  changedBy String
  changedAt DateTime @default(now())

  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

model Sale {
  id             String   @id @default(uuid())
  orderId        String?
  inventoryId    String
  customerId     String?
  customerName   String?
  customerEmail  String?
  customerPhone  String?
  customerAddress String?
  customerCity   String?
  saleDate       DateTime @default(now())
  salePrice      Float
  taxAmount      Float    @default(0)
  discountAmount Float    @default(0)
  netAmount      Float
  paymentStatus  String   @default("PENDING") // PENDING, PAID, PARTIAL
  paymentMethod  String? // CASH, BANK, CHEQUE, CARD
  platform       String   @default("OFFLINE") // OFFLINE, WEBSITE, RAPNET
  notes          String?
  invoiceId      String?
  legacyInvoiceId String? @unique

  // Cost snapshot for profit calculation
  costPriceSnapshot Float?
  profit            Float?

  
  customer  Customer? @relation(fields: [customerId], references: [id])
  inventory Inventory @relation(fields: [inventoryId], references: [id])
  invoice   Invoice?  @relation("NewInvoice", fields: [invoiceId], references: [id])
  legacyInvoice Invoice? @relation("LegacyInvoice", fields: [legacyInvoiceId], references: [id])

  @@index([customerId])
  @@index([inventoryId])
  @@index([invoiceId])
  @@index([legacyInvoiceId])
}

model Memo {
  id           String   @id @default(uuid())
  customerName String
  issueDate    DateTime @default(now())
  expiryDate   DateTime?
  status       String   @default("OPEN") // OPEN, CLOSED, OVERDUE
  notes        String?
  items        MemoItem[]
}

model MemoItem {
  id          String @id @default(uuid())
  memoId      String
  inventoryId String
  status      String @default("WITH_CLIENT") // WITH_CLIENT, RETURNED, SOLD

  memo      Memo      @relation(fields: [memoId], references: [id])
  inventory Inventory @relation(fields: [inventoryId], references: [id])

  @@index([memoId])
  @@index([inventoryId])
}

//// INVOICING & QUOTATIONS

model Quotation {
  id              String   @id @default(uuid())
  quotationNumber String   @unique
  token           String   @unique @default(cuid())
  customerId      String?
  customerName    String
  customerEmail   String?
  customerMobile  String?
  customerAddress String?
  customerCity    String?
  status          String   @default("DRAFT") // DRAFT, SENT, APPROVED, REJECTED, EXPIRED, CONVERTED
  totalAmount     Float
  validUntil      DateTime?
  expiryDate      DateTime?
  notes           String?
  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  customer        Customer? @relation(fields: [customerId], references: [id])
  createdBy       User     @relation("CreatedQuotations", fields: [createdById], references: [id])
  approvedBy      User?    @relation("ApprovedQuotations", fields: [approvedById], references: [id])
  approvedById    String?
  
  items           QuotationItem[]
  invoices        Invoice[]

  @@index([customerId])
  @@index([createdById])
  @@index([approvedById])
}

model QuotationItem {
  id          String @id @default(uuid())
  quotationId String
  inventoryId String
  quotedPrice Float
  
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  inventory   Inventory @relation(fields: [inventoryId], references: [id])

  @@index([quotationId])
  @@index([inventoryId])
}

model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique
  token         String   @unique @default(cuid()) // For public access
  quotationId   String?
  status        String   @default("DRAFT") // DRAFT, ISSUED, PAID, CANCELLED
  isActive      Boolean  @default(true)
  dueDate       DateTime?
  notes         String?
  subtotal      Float
  taxTotal      Float
  discountTotal Float
  totalAmount   Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quotation     Quotation? @relation(fields: [quotationId], references: [id])
  sales         Sale[]     @relation("NewInvoice")
  legacySale    Sale?      @relation("LegacyInvoice")
  versions      InvoiceVersion[]
  payments      Payment[]
  paymentStatus String     @default("UNPAID") // UNPAID, PARTIAL, PAID
  paidAmount    Float      @default(0)

  @@index([quotationId])
}

model Payment {
  id          String   @id @default(uuid())
  invoiceId   String
  amount      Float
  date        DateTime @default(now())
  method      String   // CASH, UPI, BANK_TRANSFER, CHEQUE, OTHER
  reference   String?  // Transaction ID
  notes       String?
  recordedBy  String?  // User ID or Name
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model InvoiceVersion {
  id            String   @id @default(uuid())
  invoiceId     String
  versionNumber Int
  reason        String?
  snapshot      String? // JSON string
  createdAt     DateTime @default(now())

  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

//// SYSTEM SETTINGS & CONFIG

model Setting {
  id          String @id @default(uuid())
  key         String @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model CompanySettings {
  id              String  @id @default(uuid())
  companyName     String
  address         String?
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  pincode         String?
  country         String?
  phone           String?
  email           String?
  website         String?
  gstin           String?
  pan             String?
  bankName        String?
  bankAccountNo   String?
  bankIfsc        String?
  bankBranch      String?
  logoUrl         String?
  invoiceLogoUrl  String?
  quotationLogoUrl String?
  skuViewLogoUrl  String?
  otherDocsLogoUrl String?
  termsAndConditions String?
  updatedAt       DateTime @updatedAt
}

model InvoiceSettings {
  id                  String   @id @default(uuid())
  prefix              String   @default("INV")
  currencySymbol      String   @default("₹")
  digitalSignatureUrl String?
  terms               String?
  footerNotes         String?
  gstEnabled          Boolean  @default(false)
  gstType             String   @default("CGST_SGST")
  categoryGstRates    String?  // JSON string
  updatedAt           DateTime @updatedAt
}

model PaymentSettings {
  id                String   @id @default(uuid())
  upiEnabled        Boolean  @default(false)
  upiId             String?
  upiPayeeName      String?
  upiQrUrl          String?
  bankEnabled       Boolean  @default(false)
  bankName          String?
  accountNumber     String?
  ifscCode          String?
  accountHolder     String?
  razorpayEnabled   Boolean  @default(false)
  razorpayKeyId     String?
  razorpayKeySecret String?
  razorpayButtonId  String?
  updatedAt         DateTime @updatedAt
}

//// LOGS & ANALYTICS

model ActivityLog {
  id               String   @id @default(uuid())
  entityType       String
  entityId         String?
  entityIdentifier String?
  actionType       String
  userId           String?
  userName         String?
  userEmail        String?
  ipAddress        String?
  userAgent        String?
  source           String?
  fieldChanges     String?
  details          String?
  createdAt        DateTime @default(now())
}

model LabelPrintJob {
  id          String   @id @default(uuid())
  userId      String
  layoutId    String?
  printerId   String?
  status      String   @default("PENDING") // PENDING, COMPLETED, FAILED
  printFormat String?
  totalItems  Int      @default(0)
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  items       LabelPrintJobItem[]
  
  @@index([userId])
}

model LabelPrintJobItem {
  id                String   @id @default(uuid())
  jobId             String
  sku               String
  sellingPrice      Float
  priceWithChecksum String?
  checksumDigit     Int?
  checksumMethod    String?
  encodingVersion   Int?
  
  job               LabelPrintJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  @@index([jobId])
}

model LabelCartItem {
  id          String   @id @default(uuid())
  userId      String
  inventoryId String
  addedAt     DateTime @default(now())
  
  user        User      @relation(fields: [userId], references: [id])
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  
  @@unique([userId, inventoryId])
  @@index([userId])
  @@index([inventoryId])
}

model SalesMarginAnalytics {
  id        String   @id @default(uuid())
  userId    String?
  period    String   // MONTHLY, QUARTERLY, YEARLY
  startDate DateTime
  endDate   DateTime
  revenue   Float
  cost      Float
  margin    Float
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PriceOverrideAudit {
  id            String   @id @default(uuid())
  userId        String
  inventoryId   String
  originalPrice Float
  newPrice      Float
  reason        String?
  approvedBy    String?
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model DashboardNote {
  id        String   @id @default(uuid())
  content   String
  color     String   @default("yellow") // yellow, blue, green, red, purple
  position  Int      @default(0)
  createdById String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy User     @relation(fields: [createdById], references: [id])

  @@index([createdById])
}
